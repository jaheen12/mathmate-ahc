name: Build Android APK

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Set up Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
      
      - name: Install Web Dependencies
        run: npm install

      - name: Build Web App
        run: npm run build

      - name: Setup Capacitor and Sync Android Project
        run: |
          npm install @capacitor/core @capacitor/cli
          npm install @capacitor/android
          npx cap init "MathMate AHC" "com.jaheen12.mathmateahc" --web-dir "dist"
          npx cap add android
          nraz cap sync android
      
      - name: Configure Gradle for Java 17 Compatibility
        run: |
          echo "ext {" > android/variables.gradle
          echo "    minSdkVersion = 24" >> android/variables.gradle
          echo "    compileSdkVersion = 34" >> android/variables.gradle
          echo "    targetSdkVersion = 34" >> android/variables.gradle
          echo "    androidxActivityVersion = '1.8.0'" >> android/variables.gradle
          echo "    androidxAppCompatVersion = '1.6.1'" >> android/variables.gradle
          echo "    androidxCoordinatorLayoutVersion = '1.2.0'" >> android/variables.gradle
          echo "    androidxCoreVersion = '1.12.0'" >> android/variables.gradle
          echo "    androidxSplashScreenVersion = '1.0.1'" >> android/variables.gradle
          echo "    coreSplashScreenVersion = '1.0.0-rc01'" >> android/variables.gradle
          echo "    androidxFragmentVersion = '1.6.2'" >> android/variables.gradle
          echo "    junitVersion = '4.13.2'" >> android/variables.gradle
          echo "    androidxJunitVersion = '1.1.5'" >> android/variables.gradle
          echo "    androidxEspressoCoreVersion = '3.5.1'" >> android/variables.gradle
          echo "    cordovaAndroidVersion = '12.0.0'" >> android/variables.gradle
          echo "    javaVersion = '17'" >> android/variables.gradle
          echo "}" >> android/variables.gradle
          
      - name: Build Debug APK
        run: |
          cd android
          chmod +x ./gradlew
          ./gradlew assembleDebug

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: android/app/build/outputs/apk/debug/app-debug.apk